#!/usr/bin/env ruby
preprocess do
  Preprocessor.configure(site)
end

compile 'assets/*' do
end

compile '*' do
  extensions = item[:split_extensions]

  extensions.reverse_each do |ext|
    case ext
    when 'handlebars', 'hbs', 'hb'
      filter :configurable_handlebars
    when 'md', 'markdown'
      filter :redcarpet, {
        :options => {
          :no_intra_emphasis => true,
          :tables => true,
          :fenced_code_blocks => true
        }
      }
      filter :nokogiri_build
      filter :pygments
      filter :nokogiri_write
    when 'erb'
      filter :erubis
    when 'html'
      page_layout = item[:page_layout] || item[:kind]
      page_layout = nil if item[:page_layout] == false
      layout page_layout if page_layout

      unless item[:layout] == false
        layout item[:layout] || 'default'
      end
    end
  end
end

route '/p1' do
  '/index.html'
end
route %r(^/p\d+/) do
  item.identifier + 'index.html'
end

route '*' do
  extensions = item[:split_extensions]

  if extensions.first == 'html'
    if item[:pretty_path] == false
      [item.identifier.chop, item[:extension]].join('.')
    else
      item.identifier + 'index.html'
    end
  else
    target = [item.identifier.chop, item[:extension]].join('.')
    if item.identifier =~ %r{^/\d{4}/\d{2}/(.*)}
      '/gallery' + target
    else
      target.sub(/\.(?:erb|hb|hbs)$/, '')
    end
  end
end

layout '*', :erubis
